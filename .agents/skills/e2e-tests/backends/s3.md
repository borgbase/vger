---
name: s3
description: "Validate vger S3 backend with bandwidth-aware corpus backup and restore"
---

# S3 Backend â€” Corpus Backup & Restore

## Goal

Validate vger backup and restore correctness on the S3 backend using the smaller remote corpus.

## Scope

- **Backend**: `s3` (credentials and endpoint from `~/vger.sample.yaml`)
- **Source dataset**: `~/corpus-remote`
- **Verification**: restored tree matches source tree exactly

## Prerequisites

1. Create config from `~/vger.sample.yaml` with S3 repo definition
2. `export VGER_PASSPHRASE=123`
3. Ensure `rclone` is configured for S3 cleanup (use credentials from sample config)

## Remote Cleanup (before each run)

Delete S3 repo contents between runs:
```bash
rclone delete <s3_remote:path> --rmdirs
```
- Do NOT use `rclone purge` (may fail with 403 on restricted buckets)
- If bucket root delete is denied, stick with content-only deletion

## Test Procedure

1. Delete repo from previous runs (best effort):
   ```bash
   vger --config <config> delete -R s3 --yes-delete-this-repo || true
   ```
2. Initialize repo:
   ```bash
   vger --config <config> init -R s3
   ```
3. Run backup:
   ```bash
   vger --config <config> backup -R s3 -l remote-corpus ~/corpus-remote
   ```
4. Confirm snapshot:
   ```bash
   vger --config <config> list -R s3 --last 3
   ```
5. Capture latest snapshot ID.
6. Restore to empty temp directory:
   ```bash
   vger --config <config> restore -R s3 <snapshot_id> <restore_dir>
   ```
7. Integrity check:
   ```bash
   vger --config <config> check -R s3
   ```
8. Delete the tested snapshot:
   ```bash
   vger --config <config> snapshot delete -R s3 <snapshot_id>
   ```
9. Compact repository packs:
   ```bash
   vger --config <config> compact -R s3
   ```

## Validation

1. Snapshot exists for label `remote-corpus`
2. Restore completes successfully
3. `diff -qr --no-dereference ~/corpus-remote <restore_dir>` reports no differences
4. `vger snapshot ... delete <snapshot_id>` exits 0
5. `vger compact` exits 0
6. Optional: SHA256 manifest comparison

## Failure Cases to Record

- S3 auth or endpoint errors
- Partial upload or timeout during backup
- Very slow backups on large corpora (use bounded smoke sources when needed)
- Restore mismatch vs source
- `vger check` failures
- `vger snapshot delete` or `vger compact` failures

## Cleanup

1. Remove restore temp directory
2. Clean S3 path with `rclone delete --rmdirs` unless keeping for debugging
