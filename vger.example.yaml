# vger example configuration
# Copy this file to vger.yaml and adjust to your needs.

# Repositories to back up to.
# Top-level settings (encryption, compression, etc.) serve as defaults.
# Each repository entry can override: encryption, compression, retention, and limits.
# Select a single repo at runtime with: vger --repo <label-or-url>
#
# URL formats:
#   Local:  /backups/repo  or  file:///backups/repo
#   S3:     s3://bucket/prefix  or  s3://endpoint:port/bucket/prefix
#   SFTP:   sftp://user@host/path  (compile with feature 'backend-sftp')
#   REST:   https://backup.example.com/repo  (compile with feature 'backend-rest')
#
# Environment expansion (applies before YAML parsing):
#   ${VAR}                -> requires VAR to be set
#   ${VAR:-default}       -> uses default when VAR is unset or empty
# Example:
#   - url: ${VGER_REPO_URL:-/backups/myrepo}
repositories:
  - url: /backups/myrepo
    label: main

  # S3 (AWS default endpoint — host is the bucket name):
  # - url: s3://my-bucket/vger
  #   label: aws
  #   region: us-east-1
  #   access_key_id: AKIA...
  #   secret_access_key: ...

  # S3-compatible (host with dot/port = custom endpoint, first path segment = bucket):
  # - url: s3://minio.local:9000/my-bucket/vger
  #   label: minio
  #   region: us-east-1
  #   access_key_id: minioadmin
  #   secret_access_key: minioadmin

  # SFTP:
  # - url: sftp://backupuser@nas.example.com/backups/vger
  #   label: remote
  #   sftp_key: ~/.ssh/id_ed25519

  # REST server (vger-server):
  # - url: https://backup.example.com/myrepo
  #   label: server
  #   rest_token: "${VGER_REST_TOKEN}"

  # Per-repo hooks — run only for this repository:
  # - url: /mnt/nas/repo
  #   label: nas
  #   hooks:
  #     before:
  #       - "mount /mnt/nas"
  #     finally:
  #       - "umount /mnt/nas"

  # Per-repo overrides:
  # - url: s3://my-bucket/vger
  #   label: offsite
  #   region: us-east-1
  #   encryption:
  #     passcommand: "pass show vger-remote"
  #   compression:
  #     algorithm: zstd              # override: better ratio for remote
  #   retention:
  #     keep_daily: 30               # override: keep more on remote

# Encryption settings
encryption:
  # Mode: "aes256gcm" or "none" (default: "aes256gcm")
  mode: aes256gcm

  # Passphrase (optional — if omitted, vger will prompt interactively)
  # passphrase: my-secret-passphrase

  # Shell command that outputs the passphrase on stdout (optional)
  # passcommand: "cat /path/to/passphrase-file"
  # Or via environment:
  # passphrase: "${VGER_PASSPHRASE}"

# Sources to back up.
# Each source produces its own snapshot per repository.
# Simple form — just a path (label derived from basename):
sources:
  - /home/user/documents
  - /home/user/photos

# Rich form — with label, per-source excludes, hooks, retention, and repo targeting:
#
# sources:
#   - path: /home/user/documents
#     label: docs
#     exclude:
#       - "*.tmp"
#       - ".git/**"
#     # Optional per-source overrides:
#     # exclude_if_present: [".nobackup", "CACHEDIR.TAG"]
#     # one_file_system: true
#     # git_ignore: false
#     # xattrs:
#     #   enabled: false
#     hooks:
#       before: "echo backing up docs"
#       after:
#         - "notify-send 'docs backup complete'"
#     retention:
#       keep_daily: 14
#       keep_weekly: 8
#     repos:               # only back up to these repos (empty = all)
#       - main
#
#   - path: /home/user/photos
#     label: photos
#     retention:
#       keep_daily: 7
#       keep_monthly: 12

# Gitignore-style patterns to exclude from all backups (merged with per-source excludes)
exclude_patterns:
  - "*.tmp"
  - "*.cache"
  - ".DS_Store"
  - "node_modules"

# Skip directories that contain any of these marker files.
exclude_if_present:
  - ".nobackup"
  - "CACHEDIR.TAG"

# Do not cross mount boundaries while walking sources.
one_file_system: true

# Respect repository .gitignore files while walking sources.
git_ignore: false

# Extended attribute handling.
xattrs:
  # Preserve filesystem extended attributes during backup and restore.
  enabled: true

# Content-defined chunking parameters (FastCDC)
chunker:
  min_size: 524288    # 512 KiB (default)
  avg_size: 2097152   # 2 MiB (default)
  max_size: 8388608   # 8 MiB (default)

# Compression settings
compression:
  # Algorithm: "lz4", "zstd", or "none" (default: "lz4")
  algorithm: lz4

  # Zstd compression level, 1-22 (default: 3, only used when algorithm is "zstd")
  zstd_level: 3

# Optional backup resource limits.
# All values are MiB/s unless noted; 0 means unlimited/no change.
#
# limits:
#   cpu:
#     # Cap backup transform workers (compression/encryption); 0 = default rayon behavior.
#     max_threads: 0
#     # Process niceness target on Unix (-20..19). 0 = leave unchanged.
#     nice: 0
#   io:
#     # Throttle source file reads during backup.
#     read_mib_per_sec: 0
#     # Throttle local repository writes (for local/file:// repositories).
#     write_mib_per_sec: 0
#   network:
#     # Throttle remote backend reads/writes (s3/sftp/rest repositories).
#     read_mib_per_sec: 0
#     write_mib_per_sec: 0

# Hooks — shell commands to run before/after vger commands.
# Global hooks apply to all repositories. Per-repo hooks go in the repo entry.
# Source-level hooks go in the source entry (simpler: before/after/failed/finally only).
#
# Hook types:
#   before / before_<cmd>   — runs before the command (failure aborts)
#   after / after_<cmd>     — runs after success only
#   failed / failed_<cmd>   — runs after failure only
#   finally / finally_<cmd> — runs always, regardless of outcome
#
# Variables: {repository}, {command}, {label}, {error}, {source_label}, {source_path}
# Env vars:  VGER_REPOSITORY, VGER_COMMAND, VGER_LABEL, VGER_ERROR,
#            VGER_SOURCE_LABEL, VGER_SOURCE_PATH
#
# hooks:
#   before_backup:
#     - "pg_dump mydb > /tmp/db.sql"
#   finally_backup:
#     - "rm -f /tmp/db.sql"
#   failed:
#     - "notify-send 'vger {command} failed: {error}'"

# Retention policy for `vger prune`
# At least one keep_* option must be set for prune to run.
# Snapshots matching multiple rules are kept (rules are additive).
# Per-source retention overrides this default (set in the source entry).
retention:
  # Keep all snapshots created within this duration
  # Supported suffixes: h (hours), d (days), w (weeks), m (months ~30d), y (years ~365d)
  # A plain number is treated as days.
  keep_within: "2d"

  # Keep the N most recent snapshots
  keep_last: 5

  # Keep N snapshots per time bucket (newest in each bucket is kept)
  keep_hourly: 24
  keep_daily: 7
  keep_weekly: 4
  keep_monthly: 6
  keep_yearly: 2

# Optional desktop scheduler settings (used by vger-gui).
# The GUI reads this as source-of-truth and auto-reloads on config edits.
#
# schedule:
#   enabled: false
#   every: "24h"                      # supports m, h, d (e.g. 30m, 6h, 2d)
#   on_startup: false
#   jitter_seconds: 0
#   passphrase_prompt_timeout_seconds: 300
